#!/bin/bash
# https://www.reddit.com/r/unixporn/comments/3358vu/i3lock_unixpornworthy_lock_screen

keepmusic=${1:-"0"}

# take screenshot and use it as background
icon="$HOME/.xlock/icon.png"
tmpbg='/tmp/screen.png'
scrot "$tmpbg"
convert "$tmpbg" -scale 20% -scale 500% "$tmpbg"
convert "$tmpbg" "$icon" -geometry +960+540 -composite -matte "$tmpbg"
convert "$tmpbg" "$icon" -geometry +2880+540 -composite -matte "$tmpbg"

# pause audioplayer and save state
if [ "$keepmusic" -eq 0 ]; then
    playerlaststate="$(getcurrentsongmpc | sed -n 1p | cut -d ' ' -f1)"
    audioplayer_control pause
fi
# reset keyboard layout
~/dev/i3wmonarch/github.com/nonpop/xkblayout-state/xkblayout-state set 0

# kill all i3block instances while the pc is locked
killall i3blocks

# turn off monitor(s)
sleep 1; xset dpms force off

lock_mac() {
ssh my.mac.lan << EOF 
        osascript -e 'tell application "Finder" to sleep'
EOF
}

unlock_mac() {
# ensure mac is locked
lock_mac
sleep 1
ssh my.mac.lan << EOF &
    set -e
    caffeinate -u -t 1
    osascript -e 'tell application "system events" to keystroke "$(gpg --decrypt $HOME/.ssh/secrets/macpass.gpg 2>/dev/null)"'
    osascript -e 'tell application "system events" to keystroke return'
    /Users/iliyan/dev/workpc_tmux.sh
EOF
}

# lock macbook
[ "$HOSTNAME" == "iliyan-arch-work-no" ] && { lock_mac;tmux kill-session -t monitorctopi; }

# lock the screen
i3lock -i "$tmpbg" -n

# restart i3
i3-msg restart

# unlock macbook
if [ "$HOSTNAME" == "iliyan-arch-work-no" ]; then 
    unlock_mac &
fi

# start playing again
if [ "$playerlaststate" = "ÔÅã" ]; then
    audioplayer_control play
fi

