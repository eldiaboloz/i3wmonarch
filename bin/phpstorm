#!/usr/bin/bash
[[ "$(basename "$0")" == *_eap* ]] && psch="1" || psch="0"
rootfolder="$HOME/.local/share/JetBrains/Toolbox/apps/PhpStorm/ch-${psch}"
[[ "$(basename "$0")" == *_r ]] && sord="" || sord="-r"
pversion=$(find "${rootfolder}" -mindepth 1 -maxdepth 1 -type d | xargs -I{} basename "{}"| sort $sord | sed -n 1p)
# locate phpstorm.sh first
phpstorme=$(realpath "$rootfolder/$pversion/bin/phpstorm.sh")

# .sh file was not found
if [ -z "$phpstorme" ]; then
    echo "phpstorm.sh was not found" 1>&2
    exit 1
fi

# vm options file
vmopts="$rootfolder/$pversion.vmoptions"
if [ ! -f "$vmopts" ]; then
    echo "phpstorm64.vmoptions file was not found" 1>&2
    exit 1
fi

# setup lang and cnt
grep -Fq -- "-Duser.country" "$vmopts" || echo '-Duser.country=BG' >> "$vmopts"
grep -Fq -- "-Duser.language" "$vmopts" || echo '-Duser.language=bg' >> "$vmopts"

# start the executable
nohup "$phpstorme" "$@" >/dev/null 2>&1 &

if [ "$#" -eq 0 ]; then
    sleep 3
else
    sleep 1
fi
i3-msg "workspace 1; layout stacked" >/dev/null 2>&1

